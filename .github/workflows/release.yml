name: Release

on:
    workflow_dispatch:
        inputs:
            version_type:
                description: "ç‰ˆæœ¬é¡žåž‹"
                required: true
                type: choice
                options:
                    - patch
                    - minor
                    - major
    push:
        tags:
            - "v*.*.*"

jobs:
    release:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Configure Git
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"

            - name: Determine version type
              id: version
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                      echo "type=${{ github.event.inputs.version_type }}" >> $GITHUB_OUTPUT
                  elif [ "${{ github.event_name }}" == "push" ]; then
                      # å¾ž tag æå–ç‰ˆæœ¬è™Ÿï¼ˆä¾‹å¦‚ v1.0.0 -> 1.0.0ï¼‰
                      TAG=${GITHUB_REF#refs/tags/}
                      TAG=${TAG#v}
                      echo "tag=$TAG" >> $GITHUB_OUTPUT
                      echo "type=tag" >> $GITHUB_OUTPUT
                  fi

            - name: Get current version
              id: current_version
              run: |
                  CURRENT_VERSION=$(bun -e "console.log(require('./package.json').version)")
                  echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
                  echo "Current version: $CURRENT_VERSION"

            - name: Calculate new version
              id: new_version
              run: |
                  CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
                  
                  if [ "${{ steps.version.outputs.type }}" == "tag" ]; then
                      # å¾ž tag ä½¿ç”¨ç‰ˆæœ¬è™Ÿ
                      NEW_VERSION="${{ steps.version.outputs.tag }}"
                  else
                      # æ ¹æ“šç‰ˆæœ¬é¡žåž‹è¨ˆç®—æ–°ç‰ˆæœ¬è™Ÿ
                      VERSION_TYPE="${{ steps.version.outputs.type }}"
                      
                      # ä½¿ç”¨ bun ä¾†è¨ˆç®—æ–°ç‰ˆæœ¬è™Ÿï¼ˆæ›´å¯é ï¼‰
                      NEW_VERSION=$(bun -e "
                      const current = '$CURRENT_VERSION';
                      const type = '$VERSION_TYPE';
                      const [major, minor, patch] = current.split('.').map(Number);
                      
                      let newMajor = major;
                      let newMinor = minor;
                      let newPatch = patch;
                      
                      switch (type) {
                          case 'major':
                              newMajor = major + 1;
                              newMinor = 0;
                              newPatch = 0;
                              break;
                          case 'minor':
                              newMinor = minor + 1;
                              newPatch = 0;
                              break;
                          case 'patch':
                              newPatch = patch + 1;
                              break;
                      }
                      
                      console.log(\`\${newMajor}.\${newMinor}.\${newPatch}\`);
                      ")
                  fi
                  
                  echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "New version: $NEW_VERSION"

            - name: Check if version already exists
              id: check_version
              run: |
                  NEW_VERSION="${{ steps.new_version.outputs.version }}"
                  if git rev-parse "v$NEW_VERSION" >/dev/null 2>&1; then
                      echo "exists=true" >> $GITHUB_OUTPUT
                      echo "âŒ Version v$NEW_VERSION already exists!"
                      exit 1
                  else
                      echo "exists=false" >> $GITHUB_OUTPUT
                      echo "âœ… Version v$NEW_VERSION is available"
                  fi

            - name: Create release branch
              run: |
                  NEW_VERSION="${{ steps.new_version.outputs.version }}"
                  BRANCH_NAME="release/v$NEW_VERSION"
                  git checkout -b "$BRANCH_NAME"
                  echo "Created branch: $BRANCH_NAME"

            - name: Update version in package.json
              run: |
                  NEW_VERSION="${{ steps.new_version.outputs.version }}"
                  bun -e "
                  const fs = require('fs');
                  const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
                  pkg.version = '$NEW_VERSION';
                  fs.writeFileSync('package.json', JSON.stringify(pkg, null, 4) + '\n');
                  "
                  echo "Updated package.json version to $NEW_VERSION"

            - name: Update CHANGELOG
              run: |
                  NEW_VERSION="${{ steps.new_version.outputs.version }}"
                  CURRENT_DATE=$(date +"%Y-%m-%d")
                  
                  # åœ¨ CHANGELOG.md é–‹é ­æ’å…¥æ–°ç‰ˆæœ¬
                  if [ -f "CHANGELOG.md" ]; then
                      # å‰µå»ºæ–°ç‰ˆæœ¬æ¢ç›®ï¼ˆä½¿ç”¨ç¹é«”ä¸­æ–‡æ ¼å¼ï¼‰
                      cat > /tmp/changelog_entry << EOF
                  
                  ## [$NEW_VERSION] - $CURRENT_DATE
                  
                  ### Added
                  - 
                  
                  ### Changed
                  - 
                  
                  ### Fixed
                  - 
                  
                  EOF
                      
                      # æ’å…¥åˆ° CHANGELOG.md é–‹é ­ï¼ˆåœ¨ç¬¬ä¸€å€‹ç‰ˆæœ¬æ¢ç›®ä¹‹å‰ï¼‰
                      # æ‰¾åˆ°ç¬¬ä¸€å€‹ "## [" çš„ä½ç½®ï¼Œåœ¨å…¶å‰é¢æ’å…¥
                      awk -v entry="$(cat /tmp/changelog_entry)" '
                      /^## \[/ && !inserted {
                          print entry
                          inserted = 1
                      }
                      { print }
                      ' CHANGELOG.md > CHANGELOG.md.tmp && mv CHANGELOG.md.tmp CHANGELOG.md
                  else
                      # å¦‚æžœæ²’æœ‰ CHANGELOG.mdï¼Œå‰µå»ºä¸€å€‹
                      cat > CHANGELOG.md << EOF
                  # Changelog
                  
                  æœ¬å°ˆæ¡ˆçš„æ‰€æœ‰é‡è¦è®Šæ›´éƒ½æœƒè¨˜éŒ„åœ¨æ­¤æ–‡ä»¶ä¸­ã€‚
                  
                  æ ¼å¼åŸºæ–¼ [Keep a Changelog](https://keepachangelog.com/zh-TW/1.0.0/)ï¼Œ
                  ç‰ˆæœ¬è™Ÿéµå¾ª [Semantic Versioning](https://semver.org/lang/zh-TW/)ã€‚
                  
                  ## [$NEW_VERSION] - $CURRENT_DATE
                  
                  ### Added
                  - 
                  
                  ### Changed
                  - 
                  
                  ### Fixed
                  - 
                  
                  EOF
                  fi
                  
                  echo "Updated CHANGELOG.md"

            - name: Commit changes
              run: |
                  NEW_VERSION="${{ steps.new_version.outputs.version }}"
                  git add package.json CHANGELOG.md
                  git commit -m "chore: bump version to $NEW_VERSION"
                  echo "Committed version update"

            - name: Push release branch
              run: |
                  BRANCH_NAME="release/v${{ steps.new_version.outputs.version }}"
                  git push origin "$BRANCH_NAME"
                  echo "Pushed branch: $BRANCH_NAME"

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  branch: release/v${{ steps.new_version.outputs.version }}
                  base: master
                  title: "chore: Release v${{ steps.new_version.outputs.version }}"
                  body: |
                      ## ðŸš€ Release v${{ steps.new_version.outputs.version }}
                      
                      ### è®Šæ›´å…§å®¹
                      - æ›´æ–°ç‰ˆæœ¬è™Ÿè‡³ `${{ steps.new_version.outputs.version }}`
                      - æ›´æ–° CHANGELOG.md
                      
                      ### ç‰ˆæœ¬é¡žåž‹
                      ${{ github.event_name == 'workflow_dispatch' && format('**{0}**', github.event.inputs.version_type) || '**tag**' }}
                      
                      ### æª¢æŸ¥æ¸…å–®
                      - [ ] ç¢ºèªç‰ˆæœ¬è™Ÿæ­£ç¢º
                      - [ ] ç¢ºèª CHANGELOG.md å·²æ›´æ–°
                      - [ ] ç¢ºèªæ‰€æœ‰æ¸¬è©¦é€šéŽ
                      - [ ] ç¢ºèªå»ºç½®æˆåŠŸ
                      
                      ### ä¸‹ä¸€æ­¥
                      åˆä½µæ­¤ PR å¾Œï¼Œå°‡è‡ªå‹•è§¸ç™¼ç™¼å¸ƒæµç¨‹ã€‚
                      
                      ---
                      *æ­¤ PR ç”± GitHub Actions è‡ªå‹•å‰µå»º*
                  labels: |
                      release
                      automated
                  draft: false

